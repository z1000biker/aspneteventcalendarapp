@model IEnumerable<EventCalendarApp.Models.Event>
@{
    ViewData["Title"] = "Calendar";
}

<div class="calendar-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="display-5 fw-bold">ðŸ“… Event Calendar</h1>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Create Event
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="calendar-container">
    <div id="calendar"></div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="editEventBtn" href="#" class="btn btn-primary">Edit</a>
                <button type="button" id="deleteEventBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            var currentEventId = null;

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                events: function(info, successCallback, failureCallback) {
                    fetch('/api/eventsapi?start=' + info.startStr + '&end=' + info.endStr)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                var events = data.data.map(function(evt) {
                                    return {
                                        id: evt.id,
                                        title: evt.title,
                                        start: evt.startDate,
                                        end: evt.endDate,
                                        allDay: evt.isAllDay,
                                        backgroundColor: evt.color,
                                        borderColor: evt.color,
                                        extendedProps: {
                                            description: evt.description,
                                            location: evt.location,
                                            category: evt.category
                                        }
                                    };
                                });
                                successCallback(events);
                            } else {
                                failureCallback();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching events:', error);
                            failureCallback();
                        });
                },
                eventClick: function(info) {
                    currentEventId = info.event.id;
                    var event = info.event;
                    
                    var modalBody = document.getElementById('eventModalBody');
                    modalBody.innerHTML = `
                        <div class="event-details">
                            <h5>${event.title}</h5>
                            ${event.extendedProps.description ? `<p><strong>Description:</strong> ${event.extendedProps.description}</p>` : ''}
                            <p><strong>Start:</strong> ${event.start.toLocaleString()}</p>
                            <p><strong>End:</strong> ${event.end ? event.end.toLocaleString() : 'N/A'}</p>
                            ${event.extendedProps.location ? `<p><strong>Location:</strong> ${event.extendedProps.location}</p>` : ''}
                            <p><strong>Category:</strong> <span class="badge" style="background-color: ${event.backgroundColor}">${event.extendedProps.category}</span></p>
                            <p><strong>All Day:</strong> ${event.allDay ? 'Yes' : 'No'}</p>
                        </div>
                    `;
                    
                    document.getElementById('editEventBtn').href = '/Events/Edit/' + event.id;
                    eventModal.show();
                },
                select: function(info) {
                    window.location.href = '/Events/Create?start=' + info.startStr + '&end=' + info.endStr;
                },
                eventDrop: function(info) {
                    updateEventDates(info.event);
                },
                eventResize: function(info) {
                    updateEventDates(info.event);
                }
            });

            calendar.render();

            // Delete event handler
            document.getElementById('deleteEventBtn').addEventListener('click', function() {
                if (currentEventId && confirm('Are you sure you want to delete this event?')) {
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/Events/Delete/' + currentEventId;
                    
                    var token = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (token) {
                        var hiddenToken = document.createElement('input');
                        hiddenToken.type = 'hidden';
                        hiddenToken.name = '__RequestVerificationToken';
                        hiddenToken.value = token.value;
                        form.appendChild(hiddenToken);
                    }
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });

            function updateEventDates(event) {
                var eventData = {
                    id: parseInt(event.id),
                    title: event.title,
                    description: event.extendedProps.description,
                    startDate: event.start.toISOString(),
                    endDate: event.end ? event.end.toISOString() : event.start.toISOString(),
                    location: event.extendedProps.location,
                    category: event.extendedProps.category,
                    isAllDay: event.allDay
                };

                fetch('/api/eventsapi/' + event.id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Error updating event: ' + data.message);
                        calendar.refetchEvents();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating event');
                    calendar.refetchEvents();
                });
            }
        });
    </script>
}

<form method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>
